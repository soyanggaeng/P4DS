<!DOCTYPE html>
<html>
<head>
    <title>YAMP: Youtube Ad Matching Platform - Proposal</title>
    <link rel="stylesheet" type="text/css" href="static/css/styles.css">
    <script type="text/javascript" src="static/js/common.js"></script>
    <script type="text/javascript" src="static/js/user.js"></script>
    <style>
        .search-container {
            padding-left : 0px;
        }

        #proposal-form input[name="youtuber-name"]{
            margin-bottom : 0px;
            width : 200px;
        }
    </style>
</head>
<body>
    <header>
        <script>
            h1 = "Channel Proposal"
            h3 = "Recommendation and Submission"
        </script>
    </header>

    <nav>
        <div class="login-button-container">
            <a href="#" id="logout-button">Log Out</a>
        </div>
    </nav>
    
    <section id="proposal-recommendation">
        <h2>Channel Recommendation</h2>
        <p>Based on your budget and the product to be advertised, we have identified the YouTube channels that would be most effective for your advertising campaign:</p>
        <!-- Include the channel recommendations here -->
    </section>
    
    <section id="proposal-submission">
        <h2>Proposal Submission</h2>
        <p>Send a proposal to the recommended YouTubers through our YAMP service:</p>
        <form id="proposal-form" action="/updateProposal", method="post">
            <label for="youtuber-name">YouTuber Name:</label>
            <div class="search-container">
                <div class="autocomplete">
                    <input type="text" id="youtuber-name" name="youtuber-name" placeholder="Enter YouTuber's Name" required>
                    <div id="suggestions"></div>
                </div>
                <button id="search_btn" type="button">Search</button>
            </div>
            
            <label for="contact-email">Contact Email:</label>
            <input type="email" id="contact-email" name="contact-email" placeholder="Enter Your Email Address" required>
            
            <label for="product">Product:</label>
            <select id="product" name="product" required>
                <option value="" disabled selected>Select Product Type</option>
                <option value="technology">Technology</option>
                <option value="gaming">Gaming</option>
                <option value="beauty-fashion">Beauty and Fashion</option>
                <option value="food-beverage">Food and Beverage</option>
                <option value="health-fitness">Health and Fitness</option>
                <option value="travel-tourism">Travel and Tourism</option>
                <option value="automotive">Automotive</option>
                <option value="entertainment-media">Entertainment and Media</option>
                <option value="home-lifestyle">Home and Lifestyle</option>
                <option value="financial-services">Financial Services</option>
            </select>
            
            <label for="budget">Budget:</label>
            <input type="number" id="budget" name="budget" placeholder="Enter Budget Amount" required>
            
            <label for="timeline">Timeline:</label>
            <input type="text" id="timeline" name="timeline" placeholder="Enter Proposed Timeline" required>
            
            <label for="message">Message:</label>
            <textarea id="message" name="message" placeholder="Enter Your Proposal Message" required></textarea>
            
            <input type="submit" value="Send Proposal">
        </form>        
    </section>
    
    <footer>
    </footer>

    <script>
        var database;
        window.onload = function () {
            communicate('/getYoutuberInfo', {})
                .then(data => {
                    database = data;
                });
            }


        var activeSuggestion = -1;

        document.querySelector('#youtuber-name').addEventListener('keyup', function(e){
            const suggestionsDiv = document.getElementById('suggestions');
            const children = Array.from(suggestionsDiv.children);

            if(e.key == 'Enter'){
                e.preventDefault();
                if(activeSuggestion > -1){
                    children[activeSuggestion].click();
                }
                else{
                    document.querySelector('#youtuber-name').blur();
                    document.querySelector('#search_btn').click();
                    suggestionsDiv.innerHTML = "";
                    suggestionsDiv.style.display = "none";
                    activeSuggestion = -1
                }
                }
            });

        document.querySelector('#youtuber-name').addEventListener('keydown', function(e){
            const suggestionsDiv = document.getElementById('suggestions');
            const children = Array.from(suggestionsDiv.children);

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                const nextIndex = activeSuggestion >= 0 ? (activeSuggestion + 1) % children.length : activeSuggestion+1;
                // const nextIndex = activeSuggestion+1;
                setActiveSuggestion(nextIndex);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prevIndex = activeSuggestion > -1 ? activeSuggestion - 1 : -1;
                setActiveSuggestion(prevIndex);
            } else if (e.key != "Enter") {
                setTimeout(() => {autocomplete(e);}, 0);
            } else if(e.key == "Enter"){
                e.preventDefault();
            }
        })


        var searchButton = document.getElementById("search_btn");
        searchButton.addEventListener("click", searchYouTuber);

        function searchYouTuber() {
            var youtuberName = document.getElementById("youtuber-name").value;
            var contactEmail = document.getElementById("contact-email");
            var foundYoutuber = database.find(function(youtuber) {
                return youtuber.title.toLowerCase() === youtuberName.toLowerCase();
            });

            if (foundYoutuber) {
                contactEmail.value = foundYoutuber.mails;
            } else {
                contactEmail.value = "";
                alert("YouTuber not found in the database.");
            }
        }

        var timelineInput = document.getElementById("timeline");
        var currentDatetime = new Date();
        var currentDatetimeString = currentDatetime.toLocaleString('en-US');
        timelineInput.value = currentDatetimeString;


        
        function autocomplete(e) {
                const suggestionsDiv = document.getElementById('suggestions');
                let suggestions=[];

                const input = document.getElementById('youtuber-name');
                const query = input.value.toLowerCase();
                
                console.log(query)

                // Filter the search targets based on the query
                const sug_list = database.filter(function(item) {
                    return item.title.toLowerCase().includes(query)
                });
                if (input.value != ""){
                    suggestions = sug_list.map(item => item.title);
                }

                // console.log(suggestions);

                suggestionsDiv.innerHTML = ''

                // Display the suggestions

                suggestions.forEach((suggestion, index) => {
                    const div = document.createElement('div');
                    div.textContent = suggestion;
                    div.id = 'suggestion-' + index;
                    div.onclick = selectSuggestion;
                    div.onmouseover = function() {
                        setActiveSuggestion(index);
                    };
                    div.onmouseleave = function() {
                        if(isKorean(e.key)){
                            setActiveSuggestion(-2);
                        } else{
                            setActiveSuggestion(-1);
                        }
                    };
                    suggestionsDiv.appendChild(div);
                });

                suggestionsDiv.style.display = suggestions.length ? 'block' : 'none';

                activeSuggestion = isKorean(e.key) ? -2 : -1;
            }

            function setActiveSuggestion(index) {
                const suggestionsDiv = document.getElementById('suggestions');
                const children = Array.from(suggestionsDiv.children);
                children.forEach((child, i) => {
                    child.style.background = i === index ? '#ddd' : '#fff';
                });
                activeSuggestion = index;

                if (activeSuggestion >= 0) {
                    children[activeSuggestion].scrollIntoView({ block: 'nearest' });
                }
            }

            function selectSuggestion() {
                const input = document.getElementById('youtuber-name');
                const suggestionsDiv = document.getElementById('suggestions');
                input.value = this.textContent;
                input.focus();
                suggestionsDiv.style.display = 'none';
                activeSuggestion = -1;
            }

            function isKorean(char) {
            const unicode = char.charCodeAt(0);
            return ((unicode >= 0xAC00 && unicode <= 0xD7A3) ||  // Hangul Syllables
                    (unicode >= 0x1100 && unicode <= 0x11FF) ||  // Hangul Jamo
                    (unicode >= 0x3130 && unicode <= 0x318F) ||  // Hangul Compatibility Jamo
                    (unicode >= 0xA960 && unicode <= 0xA97F) ||  // Hangul Jamo Extended-A
                    (unicode >= 0xD7B0 && unicode <= 0xD7FF));   // Hangul Jamo Extended-B
        }
    </script>   
</body>
</html>

